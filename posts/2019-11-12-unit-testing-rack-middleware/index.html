<!doctype html><html lang=en><head><script src="https://www.googletagmanager.com/gtag/js?id=UA-152407711-1" async></script><script>window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-152407711-1');</script><meta content="Thoughts and learnings on writing better software" name=description><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="Thoughts and learnings on writing better software" name=description><title>Tejas' Blog - Unit testing rack middleware</title><link href=https://tejasbubane.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link href=https://tejasbubane.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><script defer src=https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js></script><link href=https://tejasbubane.github.io/site.css rel=stylesheet><link href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel=stylesheet><body><div class=container><div class=mobile-navbar id=mobile-navbar><div class=mobile-header-logo><a class=logo href=https://tejasbubane.github.io>Tejas' Blog</a></div><div class="mobile-navbar-icon icon-out"><span></span><span></span><span></span></div></div><nav class="mobile-menu slideout-menu slideout-menu-left" id=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a href=https://tejasbubane.github.io> Home </a><li class=mobile-menu-item><a href=https://tejasbubane.github.io/services> Services </a><li class=mobile-menu-item><a href=https://tejasbubane.github.io/setup> Setup </a><li class=mobile-menu-item><a href=https://tejasbubane.github.io/books> Books </a><li class=mobile-menu-item><a href=https://tejasbubane.github.io/atom.xml> RSS </a></ul></nav><header id=header><div class=site-info><h1 class=site-name><a href=https://tejasbubane.github.io>Tejas Bubane</a></h1><p class=site-description>Ruby | Javascript | Haskell | λ</div><nav class=menu><ul><li><a href=https://tejasbubane.github.io> Home </a><li><a href=https://tejasbubane.github.io/services> Services </a><li><a href=https://tejasbubane.github.io/setup> Setup </a><li><a href=https://tejasbubane.github.io/books> Books </a><li><a href=https://tejasbubane.github.io/atom.xml> RSS </a></ul></nav></header><main><div class=content id=mobile-panel><article class=post><header class=post__header><h1 class=post__title><a href=https://tejasbubane.github.io/posts/2019-11-12-unit-testing-rack-middleware/>Unit testing rack middleware</a></h1><div class=post__meta><span class=post__time>November 12, 2019</span><span class=post-tags> <a href=https://tejasbubane.github.io/tags/ruby/>#ruby</a> <a href=https://tejasbubane.github.io/tags/rack/>#rack</a> <a href=https://tejasbubane.github.io/tags/rspec/>#rspec</a> <a href=https://tejasbubane.github.io/tags/testing/>#testing</a> </span></div></header><div class=post-content><p>Underneath (almost) all Ruby web application lies the <a href=http://rack.github.io/ rel=external>Rack</a> architecture. With minimal interface, it is simple to write a middleware. Let's see how to test it.</p><span id=continue-reading></span><p>A middleware is anything which responds to <code>call</code> method (<a href=https://en.wikipedia.org/wiki/Duck_typing rel=external>duck-typing</a>).<p><strong>Aside:</strong> Lambdas and procs in Ruby can be executed with <code>.call</code> so they can be middlewares as well.<p>Our example middleware allows requests to pass through only if the required headers are present:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=ruby><span class=giallo-l><span style=color:#f97583>class</span><span style=color:#b392f0> BlockActions</span></span>
<span class=giallo-l><span style=color:#f97583>  def</span><span style=color:#b392f0> initialize</span><span>(app)</span></span>
<span class=giallo-l><span>    @app</span><span style=color:#f97583> =</span><span> app</span></span>
<span class=giallo-l><span style=color:#f97583>  end</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f97583>  def</span><span style=color:#b392f0> call</span><span>(env)</span></span>
<span class=giallo-l><span style=color:#f97583>    unless</span><span> env[</span><span style=color:#9ecbff>"HTTP_X_CLIENT"</span><span>]</span><span style=color:#f97583> ==</span><span style=color:#9ecbff> "mobile"</span><span style=color:#f97583> &&</span><span> env[</span><span style=color:#9ecbff>"HTTP_X_MOBILE_USER_ID"</span><span>]</span></span>
<span class=giallo-l><span style=color:#f97583>      return</span><span> [</span></span>
<span class=giallo-l><span style=color:#79b8ff>        400</span><span>,</span><span style=color:#6a737d> # status</span></span>
<span class=giallo-l><span>        {</span><span style=color:#9ecbff> "Content-Type"</span><span> =></span><span style=color:#9ecbff> "application/json"</span><span> },</span><span style=color:#6a737d> # headers</span></span>
<span class=giallo-l><span>        [</span><span style=color:#9ecbff>"Invalid Request"</span><span>]</span><span style=color:#6a737d> # response body</span></span>
<span class=giallo-l><span>      ]</span></span>
<span class=giallo-l><span style=color:#f97583>    end</span></span>
<span class=giallo-l><span>    @app.</span><span style=color:#b392f0>call</span><span>(env)</span></span>
<span class=giallo-l><span style=color:#f97583>  end</span></span>
<span class=giallo-l><span style=color:#f97583>end</span></span></code></pre><p>Now in order to test this, we have to write <a href=https://guides.rubyonrails.org/testing.html#integration-testing rel=external>integration tests</a> which is fine, but they are slow. Especially if you want to benchmark the middleware to see if it is not doing some nasty thing in some edgecase that bumps up your response times.<p>As described before, rack middleware is a simple class with call method. Let's test it in isolation:<p>We need 2 things: the middleware instance & env to be passed in. Middleware instance is simple class instance, but to create env, we will use <a href=https://www.rubydoc.info/gems/rack/Rack/MockRequest rel=external>MockRequest</a><pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=ruby><span class=giallo-l><span style=color:#79b8ff>Rack</span><span>::</span><span style=color:#79b8ff>MockRequest</span><span>.</span><span style=color:#b392f0>env_for</span><span>(</span><span style=color:#9ecbff>"/"</span><span>,</span><span style=color:#79b8ff> method: :get</span><span>)</span></span></code></pre><p>Our middleware does not care about routes so it might as well be:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=ruby><span class=giallo-l><span style=color:#79b8ff>Rack</span><span>::</span><span style=color:#79b8ff>MockRequest</span><span>.</span><span style=color:#b392f0>env_for</span></span></code></pre><p>Putting it into specs:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=ruby><span class=giallo-l><span>describe </span><span style=color:#79b8ff>BlockActions</span><span style=color:#f97583> do</span></span>
<span class=giallo-l><span style=color:#6a737d>  # Mock env to pass in middleware</span></span>
<span class=giallo-l><span style=color:#b392f0>  let</span><span>(</span><span style=color:#79b8ff>:env</span><span>) {</span><span style=color:#79b8ff> Rack</span><span>::</span><span style=color:#79b8ff>MockRequest</span><span>.</span><span style=color:#b392f0>env_for</span><span> }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#6a737d>  # dummy app to validate success</span></span>
<span class=giallo-l><span style=color:#b392f0>  let</span><span>(</span><span style=color:#79b8ff>:app</span><span>) {</span><span style=color:#79b8ff> -></span><span>(env) { [</span><span style=color:#79b8ff>200</span><span>, {},</span><span style=color:#9ecbff> "success"</span><span>] } }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  subject {</span><span style=color:#79b8ff> BlockActions</span><span>.</span><span style=color:#f97583>new</span><span>(app) }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  it </span><span style=color:#9ecbff>"allows if client & user-id headers are present"</span><span style=color:#f97583> do</span></span>
<span class=giallo-l><span>    env[</span><span style=color:#9ecbff>"HTTP_X_CLIENT"</span><span>]</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "mobile"</span></span>
<span class=giallo-l><span>    env[</span><span style=color:#9ecbff>"HTTP_X_MOBILE_USER_ID"</span><span>]</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 1</span></span>
<span class=giallo-l><span>    status,</span><span style=color:#79b8ff> _headers</span><span>,</span><span style=color:#79b8ff> _response</span><span style=color:#f97583> =</span><span> subject.</span><span style=color:#b392f0>call</span><span>(env)</span></span>
<span class=giallo-l><span style=color:#b392f0>    expect</span><span>(status).</span><span style=color:#b392f0>to eq</span><span>(</span><span style=color:#79b8ff>200</span><span>)</span></span>
<span class=giallo-l><span style=color:#f97583>  end</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  it </span><span style=color:#9ecbff>"does not allow if client is missing"</span><span style=color:#f97583> do</span></span>
<span class=giallo-l><span>    env[</span><span style=color:#9ecbff>"HTTP_X_MOBILE_USER_ID"</span><span>]</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 1</span></span>
<span class=giallo-l><span>    status,</span><span style=color:#79b8ff> _headers</span><span>,</span><span style=color:#79b8ff> _response</span><span style=color:#f97583> =</span><span> subject.</span><span style=color:#b392f0>call</span><span>(env)</span></span>
<span class=giallo-l><span style=color:#b392f0>    expect</span><span>(status).</span><span style=color:#b392f0>to eq</span><span>(</span><span style=color:#79b8ff>400</span><span>)</span></span>
<span class=giallo-l><span style=color:#f97583>  end</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  it </span><span style=color:#9ecbff>"does not allow if mobile-user-id is missing"</span><span style=color:#f97583> do</span></span>
<span class=giallo-l><span>    env[</span><span style=color:#9ecbff>"HTTP_X_CLIENT"</span><span>]</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "mobile"</span></span>
<span class=giallo-l><span>    status,</span><span style=color:#79b8ff> _headers</span><span>,</span><span style=color:#79b8ff> _response</span><span style=color:#f97583> =</span><span> subject.</span><span style=color:#b392f0>call</span><span>(env)</span></span>
<span class=giallo-l><span style=color:#b392f0>    expect</span><span>(status).</span><span style=color:#b392f0>to eq</span><span>(</span><span style=color:#79b8ff>400</span><span>)</span></span>
<span class=giallo-l><span style=color:#f97583>  end</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  it </span><span style=color:#9ecbff>"does not allow if client is not mobile"</span><span style=color:#f97583> do</span></span>
<span class=giallo-l><span>    env[</span><span style=color:#9ecbff>"HTTP_X_CLIENT"</span><span>]</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "jared"</span></span>
<span class=giallo-l><span>    status,</span><span style=color:#79b8ff> _headers</span><span>,</span><span style=color:#79b8ff> _response</span><span style=color:#f97583> =</span><span> subject.</span><span style=color:#b392f0>call</span><span>(env)</span></span>
<span class=giallo-l><span style=color:#b392f0>    expect</span><span>(status).</span><span style=color:#b392f0>to eq</span><span>(</span><span style=color:#79b8ff>400</span><span>)</span></span>
<span class=giallo-l><span style=color:#f97583>  end</span></span>
<span class=giallo-l><span style=color:#f97583>end</span></span></code></pre><p>Because these are unit tests they run pretty fast:<pre class=giallo style=color:#e1e4e8;background-color:#24292e><code data-lang=plain><span class=giallo-l><span>Finished in 0.03861 seconds (files took 0.09118 seconds to load)</span></span>
<span class=giallo-l><span>4 examples, 0 failures</span></span></code></pre><p>This approach allows us to test all cases & also <a href=https://blog.heroku.com/benchmarking-rack-middleware rel=external>benchmark the middleware</a>.<p><em>All code from this blog can be found in <a href=https://gist.github.com/tejasbubane/c046640bfb1964e2678aaa138ca8e4bb rel=external>this executable script</a>.</em></div><div class=post-footer><div class=post-tags><a href=https://tejasbubane.github.io/tags/ruby/>#ruby</a><a href=https://tejasbubane.github.io/tags/rack/>#rack</a><a href=https://tejasbubane.github.io/tags/rspec/>#rspec</a><a href=https://tejasbubane.github.io/tags/testing/>#testing</a></div><div class=post-nav><a class=previous href=https://tejasbubane.github.io/posts/2020-04-22-redis-connection-pool-in-rails/>‹ Redis connection pool in Rails</a><a class=next href=https://tejasbubane.github.io/posts/2019-10-02-functor-composition/>Functor Composition ›</a></div></div></article></div></main><footer><div class=footer-content><a rel="noopener noreferrer" href=https://twitter.com/tejasbubane target=_blank> <svg viewbox="0 0 1000 1000" width=25 xmlns=http://www.w3.org/2000/svg><path d="M0 781.864q0 7.32 7.32 13.176 12.2 8.296 43.432 24.4 119.072 61.488 249.856 61.488 162.992 0 296.216 -83.936 63.44 -40.016 112.728 -96.38t78.324 -117.608 43.432 -122.732 13.42 -119.56v-17.08q57.096 -40.992 89.304 -93.696 2.928 -5.856 2.928 -8.784 0 -6.344 -4.88 -11.224t-11.224 -4.88q-3.416 0 -11.712 3.904 -5.856 1.952 -14.396 4.88t-14.64 5.124 -8.052 2.684q12.688 -14.152 26.352 -38.308t13.664 -35.38q0 -6.344 -4.88 -10.98t-11.712 -4.636q-3.904 0 -7.808 2.44 -55.632 29.768 -103.944 40.504 -59.048 -56.12 -141.032 -56.12 -83.936 0 -142.984 58.56t-59.048 141.52q0 14.64 1.952 23.912 -82.472 -6.832 -159.088 -39.528t-137.616 -87.84q-14.152 -13.664 -54.656 -57.096 -5.856 -5.856 -13.664 -5.856 -5.856 0 -12.2 7.808 -12.688 19.032 -20.008 46.604t-7.32 53.924q0 72.712 45.384 126.88l-14.152 -6.832q-12.2 -5.368 -18.056 -5.368 -8.296 0 -13.908 4.88t-5.612 12.688q0 51.24 26.352 97.112t71.248 73.2l-5.856 -.976q-.976 0 -2.684 -.488t-2.684 -.732 -1.464 -.244q-6.344 0 -10.98 4.88t-4.636 10.736q0 .488 .976 5.368 16.592 50.752 55.144 86.132t90.28 47.58q-84.912 52.216 -187.392 52.216 -6.832 0 -21.96 -1.464 -20.496 -.976 -22.448 -.976 -6.344 0 -10.98 4.88t-4.636 11.224z" fill=#c05b4d /></svg> </a><a rel="noopener noreferrer" href=https://github.com/tejasbubane target=_blank> <svg viewbox="0 0 1024 1024" width=25 xmlns=http://www.w3.org/2000/svg><path d="M512 0C229.25 0 0 229.25 0 512c0 226.25 146.688 418.125 350.156 485.812 25.594 4.688 34.938-11.125 34.938-24.625 0-12.188-.469-52.562-.719-95.312C242 908.812 211.906 817.5 211.906 817.5c-23.312-59.125-56.844-74.875-56.844-74.875-46.531-31.75 3.53-31.125 3.53-31.125 51.406 3.562 78.47 52.75 78.47 52.75 45.688 78.25 119.875 55.625 149 42.5 4.654-33 17.904-55.625 32.5-68.375-113.656-12.937-233.218-56.875-233.218-253.063 0-55.938 19.969-101.562 52.656-137.406-5.219-13-22.844-65.094 5.062-135.562 0 0 42.938-13.75 140.812 52.5 40.812-11.406 84.594-17.031 128.125-17.219 43.5.188 87.312 5.875 128.188 17.281 97.688-66.312 140.688-52.5 140.688-52.5 28 70.531 10.375 122.562 5.125 135.5 32.812 35.844 52.625 81.469 52.625 137.406 0 196.688-119.75 240-233.812 252.688 18.438 15.875 34.75 47 34.75 94.75 0 68.438-.688 123.625-.688 140.5 0 13.625 9.312 29.562 35.25 24.562C877.438 930 1024 738.125 1024 512 1024 229.25 794.75 0 512 0z" fill=#c05b4d /></svg> </a><a rel="noopener noreferrer" href=http://in.linkedin.com/in/tejasbubane target=_blank> <svg viewbox="0 0 16 16" height=25 width=25 xmlns=http://www.w3.org/2000/svg><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z" fill=#c05b4d /></svg> </a><a rel="noopener noreferrer" href=https://stackoverflow.com/users/3507206/tejasbubane target=_blank> <svg viewbox="0 0 16 16" fill=#c05b4d height=25 width=25 xmlns=http://www.w3.org/2000/svg><path d="M12.412 14.572V10.29h1.428V16H1v-5.71h1.428v4.282h9.984z"/><path d="M3.857 13.145h7.137v-1.428H3.857v1.428zM10.254 0 9.108.852l4.26 5.727 1.146-.852L10.254 0zm-3.54 3.377 5.484 4.567.913-1.097L7.627 2.28l-.914 1.097zM4.922 6.55l6.47 3.013.603-1.294-6.47-3.013-.603 1.294zm-.925 3.344 6.985 1.469.294-1.398-6.985-1.468-.294 1.397z"/></svg> </a><a rel="noopener noreferrer" href=https://speakerdeck.com/tejasbubane target=_blank> <svg viewbox="0 0 16 16" fill=#c05b4d height=25 width=25 xmlns=http://www.w3.org/2000/svg><path d="M5 6a.5.5 0 0 0-.496.438l-.5 4A.5.5 0 0 0 4.5 11h3v2.016c-.863.055-1.5.251-1.5.484 0 .276.895.5 2 .5s2-.224 2-.5c0-.233-.637-.429-1.5-.484V11h3a.5.5 0 0 0 .496-.562l-.5-4A.5.5 0 0 0 11 6H5zm2 3.78V7.22c0-.096.106-.156.19-.106l2.13 1.279a.125.125 0 0 1 0 .214l-2.13 1.28A.125.125 0 0 1 7 9.778z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/></svg> </a></div></footer></div><script src=https://tejasbubane.github.io/even.js></script>