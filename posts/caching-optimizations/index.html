<!doctype html><html lang=en><head><script src="https://www.googletagmanager.com/gtag/js?id=UA-152407711-1" async></script><script>window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-152407711-1');</script><meta content="Thoughts and learnings on writing better software" name=description><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="Thoughts and learnings on writing better software" name=description><title>Tejas' Blog - Caching optimizations</title><link href=https://tejasbubane.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link href=https://tejasbubane.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><script defer src=https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js></script><link href=https://tejasbubane.github.io/site.css rel=stylesheet><link href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel=stylesheet><body><div class=container><div class=mobile-navbar id=mobile-navbar><div class=mobile-header-logo><a class=logo href=https://tejasbubane.github.io>Tejas' Blog</a></div><div class="mobile-navbar-icon icon-out"><span></span><span></span><span></span></div></div><nav class="mobile-menu slideout-menu slideout-menu-left" id=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a href=https://tejasbubane.github.io> Home </a><li class=mobile-menu-item><a href=https://tejasbubane.github.io/services> Services </a><li class=mobile-menu-item><a href=https://tejasbubane.github.io/setup> Setup </a><li class=mobile-menu-item><a href=https://tejasbubane.github.io/atom.xml> RSS </a></ul></nav><header id=header><div class=site-info><h1 class=site-name><a href=https://tejasbubane.github.io>Tejas Bubane</a></h1><p class=site-description>Ruby | Javascript | Haskell | Î»</div><nav class=menu><ul><li><a href=https://tejasbubane.github.io> Home </a><li><a href=https://tejasbubane.github.io/services> Services </a><li><a href=https://tejasbubane.github.io/setup> Setup </a><li><a href=https://tejasbubane.github.io/atom.xml> RSS </a></ul></nav></header><main><div class=content id=mobile-panel><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a class=toc-link href=https://tejasbubane.github.io/posts/caching-optimizations/#split-cache>Split cache</a><li><a class=toc-link href=https://tejasbubane.github.io/posts/caching-optimizations/#separate-cache-store>Separate cache store</a><li><a class=toc-link href=https://tejasbubane.github.io/posts/caching-optimizations/#configuration>Configuration</a><li><a class=toc-link href=https://tejasbubane.github.io/posts/caching-optimizations/#versioning>Versioning</a> <ul><li><a class=toc-link href=https://tejasbubane.github.io/posts/caching-optimizations/#1-adding-version-to-json-body>1. Adding version to JSON body:</a><li><a class=toc-link href=https://tejasbubane.github.io/posts/caching-optimizations/#2-using-redis-databases>2. Using redis databases:</a><li><a class=toc-link href=https://tejasbubane.github.io/posts/caching-optimizations/#3-adding-version-to-cache-key>3. Adding version to cache key:</a></ul></ul></nav></div></div><article class=post><header class=post__header><h1 class=post__title><a href=https://tejasbubane.github.io/posts/caching-optimizations/>Caching optimizations</a></h1><div class=post__meta><span class=post__time>December 24, 2024</span><span class=post-tags> <a href=https://tejasbubane.github.io/tags/caching/>#caching</a> <a href=https://tejasbubane.github.io/tags/ruby/>#ruby</a> <a href=https://tejasbubane.github.io/tags/redis/>#redis</a> </span></div></header><div class=post-content><p>Some good practices when building a robust cache for backend web applications.</p><span id=continue-reading></span><p>In my <a href=https://tejasbubane.github.io/posts/redis-pipelines-to-the-rescue/ rel=noopener target=_blank>earlier blog post we saw how redis pipelines can be used to improve caching performance</a>. Now we will see some other effective optimizations which can significantly improve our caching performance. This post focuses on API response caching with JSON, backed by Redis. But the ideas are generic and can be applied elsewhere as well.<h1 id=split-cache>Split cache</h1><p>We want to achieve maximum cache hit ratio but have a large data to be cached. Some or the other entity within that JSON keeps updating and invalidating the cache. For example consider the following structure of cache:<ul><li><code>checkout_page_cache</code></ul><pre class=language-json data-lang=json style=color:#6c7079;background-color:#2b303b><code class=language-json data-lang=json><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>  </span><span style=color:#9acc76>"shopping_cart"</span><span style=color:#abb2bf>: {</span><span style=color:#fff;background-color:#e05252>...</span><span style=color:#abb2bf>},
</span><span style=color:#abb2bf>  </span><span style=color:#9acc76>"orders"</span><span style=color:#abb2bf>: {</span><span style=color:#fff;background-color:#e05252>...</span><span style=color:#abb2bf>},
</span><span style=color:#abb2bf>  </span><span style=color:#9acc76>"user"</span><span style=color:#abb2bf>: {</span><span style=color:#fff;background-color:#e05252>...</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>}
</span></code></pre><p>With this structure, cache will invalidate when any product within shopping cart, order status or user profile change. More invalidations means more cache miss and less performance.<p>On average, shopping cart changes way more often than user profile. If we split up the cache into separate parts, when shopping cart updates, we don't need to update user JSON. Not only does this increase cache hits, it also reduces DB queries for fetching related entities. So instead of single <code>checkout_page_cache</code> we have three separate ones:<ul><li><code>shopping_cart_cache</code><li><code>orders_cache</code><li><code>users_cache</code></ul><h1 id=separate-cache-store>Separate cache store</h1><p>Applications generally use Redis for multiple purposes apart from caching. eg. storing background jobs for <a href=https://sidekiq.org/ rel=noopener target=_blank>sidekiq</a>. Recommended configuration for cache store usually differs from these tools. eg. <a href=https://github.com/sidekiq/sidekiq/wiki/Using-Redis#memory rel=noopener target=_blank>Sidekiq recommends noeviction policy</a>, whereas we should always have eviction policy for cache. Also having separate redis databases is better for separation of concerns and avoiding single point of failure.<h1 id=configuration>Configuration</h1><p>All cache keys should have an expiry. The redis instance should have <code>maxmemory-policy</code> (eviction policy) set so it doesn't run out of memory - you can find <a href=https://redis.io/docs/latest/develop/reference/eviction/ rel=noopener target=_blank>all supported eviction policies and their details here</a>. It is also recommended to set read and write timeouts. More info on <a href=https://guides.rubyonrails.org/caching_with_rails.html#activesupport-cache-rediscachestore rel=noopener target=_blank>Redis cache configuration for Rails is available here</a>.<h1 id=versioning>Versioning</h1><p>Adding versions helps ease cache schema changes. eg: shopping cart cache:<pre class=language-json data-lang=json style=color:#6c7079;background-color:#2b303b><code class=language-json data-lang=json><span style=color:#abb2bf>[
</span><span style=color:#abb2bf>  {
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"product_id"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>123</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"quantity"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>  },
</span><span style=color:#abb2bf>  {
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"product_id"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>129</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"quantity"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>2</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>]
</span></code></pre><p>We decide to store basic product (name and thumbnail) info to save DB queries:<pre class=language-json data-lang=json style=color:#6c7079;background-color:#2b303b><code class=language-json data-lang=json><span style=color:#abb2bf>[
</span><span style=color:#abb2bf>  {
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"product"</span><span style=color:#abb2bf>: {
</span><span style=color:#abb2bf>      </span><span style=color:#9acc76>"id"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>123</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>      </span><span style=color:#9acc76>"name"</span><span style=color:#abb2bf>: </span><span style=color:#9acc76>"Water Bottle"</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>      </span><span style=color:#9acc76>"thumbnail"</span><span style=color:#abb2bf>: </span><span style=color:#9acc76>"https://example.com/water-bottle.jpg"
</span><span style=color:#abb2bf>    },
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"quantity"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>1
</span><span style=color:#abb2bf>  },
</span><span style=color:#abb2bf>  {</span><span style=color:#fff;background-color:#e05252>...</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>]
</span></code></pre><p>Such a change will make cache inconsistent and will need workarounds in code to handle both cases (existing + new caches). Adding version helps with better handling and debugging which can be done in few different ways:<h2 id=1-adding-version-to-json-body>1. Adding version to JSON body:</h2><pre class=language-json data-lang=json style=color:#6c7079;background-color:#2b303b><code class=language-json data-lang=json><span style=color:#abb2bf>[
</span><span style=color:#abb2bf>  {
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"product"</span><span style=color:#abb2bf>: {
</span><span style=color:#abb2bf>      </span><span style=color:#9acc76>"id"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>123</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>      </span><span style=color:#fff;background-color:#e05252>...</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    },
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"quantity"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"version"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>1
</span><span style=color:#abb2bf>  },
</span><span style=color:#abb2bf>  {
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"product"</span><span style=color:#abb2bf>: {
</span><span style=color:#abb2bf>      </span><span style=color:#9acc76>"id"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>129</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>      </span><span style=color:#fff;background-color:#e05252>...</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    },
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"quantity"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"version"</span><span style=color:#abb2bf>: </span><span style=color:#db9d63>1
</span><span style=color:#abb2bf>  },
</span><span style=color:#abb2bf>]
</span></code></pre><p>Clearly this is not the best way since it requires storing version at multiple places (especially in our example of arrays) and increases cache size.<h2 id=2-using-redis-databases>2. Using redis databases:</h2><p>If our cache store is Redis, we can switch to a new DB when we change the schema. This has a drawback: we start fresh on new DB and our application will receive heavy cache miss and DB load for a brief period during transition.<h2 id=3-adding-version-to-cache-key>3. Adding version to cache key:</h2><p>We can add version number to the cache key in addition to entity ID. eg. <code>user_123_v1</code>. Here's a generic class to make it easier:<pre class=language-ruby data-lang=ruby style=color:#6c7079;background-color:#2b303b><code class=language-ruby data-lang=ruby><span style=color:#cd74e8>class </span><span style=color:#f0c678>CacheStore
</span><span style=color:#adb7c9>  </span><span style=color:#abb2bf>VERSION </span><span style=color:#adb7c9>= </span><span style=color:#9acc76>'1'</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>freeze
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>def </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>get</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>key</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>ttl</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>   conn.get(key_name(key), ttl)
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>end
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>def </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>key_name</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>key</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>    </span><span style=color:#9acc76>"</span><span style=color:#abb2bf>#{key}</span><span style=color:#9acc76>-</span><span style=color:#abb2bf>#{</span><span style=color:#eb6772>VERSION</span><span style=color:#abb2bf>}</span><span style=color:#9acc76>"
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>end
</span><span style=color:#cd74e8>end
</span><span style=color:#abb2bf>
</span><span style=color:#f0c678>CacheStore</span><span style=color:#abb2bf>.get(</span><span style=color:#9acc76>"user-</span><span style=color:#abb2bf>#{user.id}</span><span style=color:#9acc76>"</span><span style=color:#abb2bf>)
</span></code></pre></div><div class=post-footer><div class=post-tags><a href=https://tejasbubane.github.io/tags/caching/>#caching</a><a href=https://tejasbubane.github.io/tags/ruby/>#ruby</a><a href=https://tejasbubane.github.io/tags/redis/>#redis</a></div><div class=post-nav><a class=previous href=https://tejasbubane.github.io/posts/rspec-custom-matchers/>â¹ Writing elegant custom matchers in RSpec</a><a class=next href=https://tejasbubane.github.io/posts/redis-pipelines-to-the-rescue/>Redis pipelines to the rescue âº</a></div></div></article></div></main><footer><div class=footer-content><a rel="noopener noreferrer" href=https://twitter.com/tejasbubane target=_blank> <svg viewbox="0 0 1000 1000" width=25 xmlns=http://www.w3.org/2000/svg><path d="M0 781.864q0 7.32 7.32 13.176 12.2 8.296 43.432 24.4 119.072 61.488 249.856 61.488 162.992 0 296.216 -83.936 63.44 -40.016 112.728 -96.38t78.324 -117.608 43.432 -122.732 13.42 -119.56v-17.08q57.096 -40.992 89.304 -93.696 2.928 -5.856 2.928 -8.784 0 -6.344 -4.88 -11.224t-11.224 -4.88q-3.416 0 -11.712 3.904 -5.856 1.952 -14.396 4.88t-14.64 5.124 -8.052 2.684q12.688 -14.152 26.352 -38.308t13.664 -35.38q0 -6.344 -4.88 -10.98t-11.712 -4.636q-3.904 0 -7.808 2.44 -55.632 29.768 -103.944 40.504 -59.048 -56.12 -141.032 -56.12 -83.936 0 -142.984 58.56t-59.048 141.52q0 14.64 1.952 23.912 -82.472 -6.832 -159.088 -39.528t-137.616 -87.84q-14.152 -13.664 -54.656 -57.096 -5.856 -5.856 -13.664 -5.856 -5.856 0 -12.2 7.808 -12.688 19.032 -20.008 46.604t-7.32 53.924q0 72.712 45.384 126.88l-14.152 -6.832q-12.2 -5.368 -18.056 -5.368 -8.296 0 -13.908 4.88t-5.612 12.688q0 51.24 26.352 97.112t71.248 73.2l-5.856 -.976q-.976 0 -2.684 -.488t-2.684 -.732 -1.464 -.244q-6.344 0 -10.98 4.88t-4.636 10.736q0 .488 .976 5.368 16.592 50.752 55.144 86.132t90.28 47.58q-84.912 52.216 -187.392 52.216 -6.832 0 -21.96 -1.464 -20.496 -.976 -22.448 -.976 -6.344 0 -10.98 4.88t-4.636 11.224z" fill=#c05b4d /></svg> </a><a rel="noopener noreferrer" href=https://github.com/tejasbubane target=_blank> <svg viewbox="0 0 1024 1024" width=25 xmlns=http://www.w3.org/2000/svg><path d="M512 0C229.25 0 0 229.25 0 512c0 226.25 146.688 418.125 350.156 485.812 25.594 4.688 34.938-11.125 34.938-24.625 0-12.188-.469-52.562-.719-95.312C242 908.812 211.906 817.5 211.906 817.5c-23.312-59.125-56.844-74.875-56.844-74.875-46.531-31.75 3.53-31.125 3.53-31.125 51.406 3.562 78.47 52.75 78.47 52.75 45.688 78.25 119.875 55.625 149 42.5 4.654-33 17.904-55.625 32.5-68.375-113.656-12.937-233.218-56.875-233.218-253.063 0-55.938 19.969-101.562 52.656-137.406-5.219-13-22.844-65.094 5.062-135.562 0 0 42.938-13.75 140.812 52.5 40.812-11.406 84.594-17.031 128.125-17.219 43.5.188 87.312 5.875 128.188 17.281 97.688-66.312 140.688-52.5 140.688-52.5 28 70.531 10.375 122.562 5.125 135.5 32.812 35.844 52.625 81.469 52.625 137.406 0 196.688-119.75 240-233.812 252.688 18.438 15.875 34.75 47 34.75 94.75 0 68.438-.688 123.625-.688 140.5 0 13.625 9.312 29.562 35.25 24.562C877.438 930 1024 738.125 1024 512 1024 229.25 794.75 0 512 0z" fill=#c05b4d /></svg> </a><a rel="noopener noreferrer" href=http://in.linkedin.com/in/tejasbubane target=_blank> <svg viewbox="0 0 16 16" height=25 width=25 xmlns=http://www.w3.org/2000/svg><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z" fill=#c05b4d /></svg> </a><a rel="noopener noreferrer" href=https://stackoverflow.com/users/3507206/tejasbubane target=_blank> <svg viewbox="0 0 16 16" fill=#c05b4d height=25 width=25 xmlns=http://www.w3.org/2000/svg><path d="M12.412 14.572V10.29h1.428V16H1v-5.71h1.428v4.282h9.984z"/><path d="M3.857 13.145h7.137v-1.428H3.857v1.428zM10.254 0 9.108.852l4.26 5.727 1.146-.852L10.254 0zm-3.54 3.377 5.484 4.567.913-1.097L7.627 2.28l-.914 1.097zM4.922 6.55l6.47 3.013.603-1.294-6.47-3.013-.603 1.294zm-.925 3.344 6.985 1.469.294-1.398-6.985-1.468-.294 1.397z"/></svg> </a><a rel="noopener noreferrer" href=https://speakerdeck.com/tejasbubane target=_blank> <svg viewbox="0 0 16 16" fill=#c05b4d height=25 width=25 xmlns=http://www.w3.org/2000/svg><path d="M5 6a.5.5 0 0 0-.496.438l-.5 4A.5.5 0 0 0 4.5 11h3v2.016c-.863.055-1.5.251-1.5.484 0 .276.895.5 2 .5s2-.224 2-.5c0-.233-.637-.429-1.5-.484V11h3a.5.5 0 0 0 .496-.562l-.5-4A.5.5 0 0 0 11 6H5zm2 3.78V7.22c0-.096.106-.156.19-.106l2.13 1.279a.125.125 0 0 1 0 .214l-2.13 1.28A.125.125 0 0 1 7 9.778z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/></svg> </a></div></footer></div><script src=https://tejasbubane.github.io/even.js></script>